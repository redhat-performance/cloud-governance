pipeline {
    agent {
        docker {
            label 'cloud-governance-worker'
            image 'quay.io/cloud-governance/fedora38-podman:latest'
            args  '-u root -v /etc/postfix/main.cf:/etc/postfix/main.cf --privileged --entrypoint=\'\''
        }
    }
    environment {
        QUAY_CLOUD_GOVERNANCE_REPOSITORY = credentials('QUAY_CLOUD_GOVERNANCE_REPOSITORY')
        AWS_OIDC_ROLE_ARN = credentials('cloud-governance-oidc-role-arn')
        PSAP_ASSUME_ROLE_ARN = credentials('cloud-governance-psap-assume-role-arn')
        PERFSCALE_ASSUME_ROLE_ARN = credentials('cloud-governance-perfscale-assume-role-arn')
        ES_HOST = credentials('cloud-governance-es-host')
        ES_PORT = credentials('cloud-governance-es-port')
        GITHUB_TOKEN = credentials('cloud-governance-git-access-token')
        CLOUD_GOVERNANCE_SPECIAL_USER_MAILS = credentials('cloud-governance-special-user-mails')
        LDAP_HOST_NAME = credentials('cloud-governance-ldap-host-name')
        COST_SPREADSHEET_ID = credentials('cloud-governance-cost-spreadsheet-id')
        GOOGLE_APPLICATION_CREDENTIALS = credentials('cloud-governance-google-application-credentials')

        contact1 = "ebattat@redhat.com"
        contact2 = "yinsong@redhat.com"
        contact3 = "pragchau@redhat.com"
    }
    stages {
        stage('Checkout') { // Checkout (git clone ...) the projects repository
          steps {
            checkout scm
           }
        }
        stage('Initial Cleanup') {
            steps {
                 sh '''if [[ "$(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null)" != "" ]]; then podman rmi -f $(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null); fi'''
            }
        }
        stage('Assume Role (OIDC) and Upload ElasticSearch') {
            steps {
                withCredentials([string(credentialsId: 'jenkins-oidc-token', variable: 'OIDC_TOKEN')]) {
                    sh '''
                        set -e
                        echo "Assuming role via OIDC (perf-dept)..."
                        command -v aws >/dev/null 2>&1 || { dnf install -y awscli 2>/dev/null || pip3 install --break-system-packages awscli 2>/dev/null || true; }
                        CREDS_FILE=$(mktemp)
                        AWS_ERR=$(mktemp)
                        trap "rm -f ${CREDS_FILE} ${AWS_ERR}" EXIT
                        if ! aws sts assume-role-with-web-identity \
                            --role-arn "${AWS_OIDC_ROLE_ARN}" \
                            --role-session-name "jenkins-cost-explorer-${BUILD_NUMBER}" \
                            --web-identity-token "${OIDC_TOKEN}" \
                            --duration-seconds 3600 \
                            --output json > "${CREDS_FILE}" 2>"${AWS_ERR}"; then
                            echo "OIDC assume-role failed:"
                            cat "${AWS_ERR}"
                            echo ""
                            echo "Ensure OIDC provider and JWKS are correctly set up for the issuer URL."
                            exit 1
                        fi
                        eval $(python3 -c "
import json
with open('${CREDS_FILE}') as f:
    d = json.load(f)
c = d['Credentials']
print('export AWS_ACCESS_KEY_ID=' + repr(c['AccessKeyId']))
print('export AWS_SECRET_ACCESS_KEY=' + repr(c['SecretAccessKey']))
print('export AWS_SESSION_TOKEN=' + repr(c['SessionToken']))
")
                        [ -n "${AWS_ACCESS_KEY_ID}" ] || { echo "Credentials not set after assume-role."; exit 1; }
                        echo "OIDC assume-role succeeded (perf-dept)."
                        echo "=== Validating identity (perf-dept OIDC) ==="
                        aws sts get-caller-identity
                        if [ -n "${PSAP_ASSUME_ROLE_ARN}" ]; then
                            echo "Assuming role in psap account..."
                            if ! aws sts assume-role --role-arn "${PSAP_ASSUME_ROLE_ARN}" --role-session-name "jenkins-psap-${BUILD_NUMBER}" --output json > "${CREDS_FILE}" 2>"${AWS_ERR}"; then
                                echo "PSAP assume-role failed:"; cat "${AWS_ERR}"; exit 1
                            fi
                            eval $(python3 -c "
import json
with open('${CREDS_FILE}') as f:
    d = json.load(f)
c = d['Credentials']
print('export AWS_ACCESS_KEY_ID_PSAP=' + repr(c['AccessKeyId']))
print('export AWS_SECRET_ACCESS_KEY_PSAP=' + repr(c['SecretAccessKey']))
print('export AWS_SESSION_TOKEN_PSAP=' + repr(c['SessionToken']))
")
                            echo "=== Validating identity (psap cross-account) ==="
                            ( export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID_PSAP}" AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY_PSAP}" AWS_SESSION_TOKEN="${AWS_SESSION_TOKEN_PSAP}"; aws sts get-caller-identity )
                        fi
                        if [ -n "${PERFSCALE_ASSUME_ROLE_ARN}" ]; then
                            echo "Assuming role in perf-scale account..."
                            if ! aws sts assume-role --role-arn "${PERFSCALE_ASSUME_ROLE_ARN}" --role-session-name "jenkins-perfscale-${BUILD_NUMBER}" --output json > "${CREDS_FILE}" 2>"${AWS_ERR}"; then
                                echo "PERFSCALE assume-role failed:"; cat "${AWS_ERR}"; exit 1
                            fi
                            eval $(python3 -c "
import json
with open('${CREDS_FILE}') as f:
    d = json.load(f)
c = d['Credentials']
print('export AWS_ACCESS_KEY_ID_PERFSCALE=' + repr(c['AccessKeyId']))
print('export AWS_SECRET_ACCESS_KEY_PERFSCALE=' + repr(c['SecretAccessKey']))
print('export AWS_SESSION_TOKEN_PERFSCALE=' + repr(c['SessionToken']))
")
                            echo "=== Validating identity (perf-scale cross-account) ==="
                            ( export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID_PERFSCALE}" AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY_PERFSCALE}" AWS_SESSION_TOKEN="${AWS_SESSION_TOKEN_PERFSCALE}"; aws sts get-caller-identity )
                        fi
                        echo "Running upload script..."
                        python3 jenkins/clouds/aws/daily/cost_explorer/run_upload_es.py
                    '''
                }
            }
        }
        stage('Finalize Cleanup') {
            steps {
                 sh '''if [[ "$(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null)" != "" ]]; then podman rmi -f $(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null); fi'''
                 deleteDir()
            }
        }
    }
    post {
       always {
           deleteDir()
       }
        // failure {
        //       script {
        //         msg = "Build error for ${env.JOB_NAME} ${env.BUILD_NUMBER} (${env.BUILD_URL})"
        //         emailext body: """\
        //     Jenkins job: ${env.BUILD_URL}\nSee the console output for more details:  ${env.BUILD_URL}consoleFull\n\n
        //     """,
        //         subject: msg,
        //         to: "${contact1}, ${contact2}, ${contact3}"
        //     }
        // }
    }
}
