pipeline {
    agent {
        docker {
            label 'cloud-governance-worker'
            image 'quay.io/cloud-governance/fedora38-podman:latest'
            args  '-u root -v /etc/postfix/main.cf:/etc/postfix/main.cf --privileged'
        }
    }
    environment {
        QUAY_CLOUD_GOVERNANCE_REPOSITORY = credentials('QUAY_CLOUD_GOVERNANCE_REPOSITORY')
        // OIDC: role ARN for AssumeRoleWithWebIdentity (issuer: https://cloud-governance-oidc-keys.s3.us-east-1.amazonaws.com)
        AWS_OIDC_ROLE_ARN = 'arn:aws:iam::452958939641:role/cloud-governance-oidc-jenkins-role'
        ES_HOST = credentials('cloud-governance-es-host')
        ES_PORT = credentials('cloud-governance-es-port')
        GITHUB_TOKEN = credentials('cloud-governance-git-access-token')
        CLOUD_GOVERNANCE_SPECIAL_USER_MAILS = credentials('cloud-governance-special-user-mails')
        LDAP_HOST_NAME = credentials('cloud-governance-ldap-host-name')
        COST_SPREADSHEET_ID = credentials('cloud-governance-cost-spreadsheet-id')
        GOOGLE_APPLICATION_CREDENTIALS = credentials('cloud-governance-google-application-credentials')

        contact1 = "ebattat@redhat.com"
        contact2 = "yinsong@redhat.com"
        contact3 = "pragchau@redhat.com"
    }
    stages {
        stage('Checkout') { // Checkout (git clone ...) the projects repository
          steps {
            checkout scm
           }
        }
        stage('Initial Cleanup') {
            steps {
                 sh '''if [[ "$(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null)" != "" ]]; then podman rmi -f $(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null); fi'''
            }
        }
        stage('Assume Role (OIDC) and Upload ElasticSearch') {
            steps {
                withCredentials([string(credentialsId: 'jenkins-oidc-token', variable: 'OIDC_TOKEN')]) {
                    sh '''
                        set -e
                        echo "Assuming role via OIDC..."
                        eval $(aws sts assume-role-with-web-identity \
                            --role-arn "${AWS_OIDC_ROLE_ARN}" \
                            --role-session-name "jenkins-cost-explorer-${BUILD_NUMBER}" \
                            --web-identity-token "${OIDC_TOKEN}" \
                            --duration-seconds 3600 \
                            --output json | python3 -c "
import json, sys
d = json.load(sys.stdin)
c = d['Credentials']
print('export AWS_ACCESS_KEY_ID=' + repr(c['AccessKeyId']))
print('export AWS_SECRET_ACCESS_KEY=' + repr(c['SecretAccessKey']))
print('export AWS_SESSION_TOKEN=' + repr(c['SessionToken']))
")
                        echo "Assume role succeeded; running upload script..."
                        python3 jenkins/clouds/aws/daily/cost_explorer/run_upload_es.py
                    '''
                }
            }
        }
        stage('Finalize Cleanup') {
            steps {
                 sh '''if [[ "$(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null)" != "" ]]; then podman rmi -f $(podman images -q ${QUAY_CLOUD_GOVERNANCE_REPOSITORY} 2> /dev/null); fi'''
                 deleteDir()
            }
        }
    }
    post {
       always {
           deleteDir()
       }
        failure {
              script {
                msg = "Build error for ${env.JOB_NAME} ${env.BUILD_NUMBER} (${env.BUILD_URL})"
                emailext body: """\
            Jenkins job: ${env.BUILD_URL}\nSee the console output for more details:  ${env.BUILD_URL}consoleFull\n\n
            """,
                subject: msg,
                to: "${contact1}, ${contact2}, ${contact3}"
            }
        }
    }
}
